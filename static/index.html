<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="boydog" />
    <title>boydog-noot</title>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/reconnecting-websocket/1.0.0/reconnecting-websocket.min.js"
      integrity="sha512-B4skI5FiLurS86aioJx9VfozI1wjqrn6aTdJH+YQUmCZum/ZibPBTX55k5d9XM6EsKePDInkLVrN7vPmJxc1qA=="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/cash/8.1.0/cash.min.js"
      integrity="sha512-sgDgZX/GgfD7qSeMjPN/oE9EQgXZJW55FIjdexVT60QerG2gAWhR9QDQEGt3O90Dy9jVcwMWsoTMhLgldIiKXw=="
      crossorigin="anonymous"
    ></script>
  </head>

  <body>
    <div>
      <input bd-model="word" />
      <input bd-model="thing" />
    </div>
    <script>
      const socket = new ReconnectingWebSocket("ws://localhost:3080")

      let scope = {}
      let domScope = {}

      // Create scope vars
      $("[bd-model]").each((i, el) => {
        const path = el.getAttribute("bd-model")
        scope[path] = ""

        if (domScope[path] !== []) domScope[path] = []
        domScope[path].push((newVal) => {
          el["value"] = newVal
        })

        $(el).on("input", (ev) => {
          socket.send(JSON.stringify({ p: path, v: ev.target.value }))
        })
      })

      socket.onopen = () => {
        console.log("onopen")
      }
      socket.onerror = (error) => {
        console.log(`WebSocket error: ${error}`)
      }
      socket.onmessage = (msg) => {
        msg = JSON.parse(msg.data)
        scope[msg.p] = msg.v
        console.log("scope", scope)

        if (domScope[msg.p] === undefined) return
        domScope[msg.p].forEach((o) => {
          o(scope[msg.p])
        })
      }
    </script>
  </body>
</html>
